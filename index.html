<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventory Gudang</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<!-- SheetJS (Export Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }
body, html { margin:0; padding:0; font-family: Arial,sans-serif; height:100vh; display:flex; flex-direction:column; }
.wrapper { min-height:100vh; display:flex; flex-direction:column; flex-grow:1; }
header { background:#1e90ff; color:white; text-align:center; padding:0; height:120px; line-height:120px; font-size:32px; font-weight:bold; user-select:none; flex-shrink:0; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:relative; }
#autoRefreshIndicator { position:absolute; top:15px; right:20px; width:16px; height:16px; border-radius:50%; background:#ccc; box-shadow:0 0 5px rgba(0,0,0,0.2); }
.main-content { display:flex; flex:1; overflow:hidden; min-height:0; position:relative; }
.sidebar { background:#333; width:220px; padding:20px; display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto; transition: transform 0.3s ease; }
.sidebar a, .sidebar button { background:#444; color:white; text-decoration:none; border:none; padding:12px 15px; margin-bottom:10px; border-radius:5px; text-align:left; cursor:pointer; font-size:16px; transition:0.3s; }
.sidebar a:hover, .sidebar button:hover { background:#1e90ff; }
.content { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; min-height:0; overflow-x:auto; transition: margin-left 0.3s ease; }
.filters { margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.filters input[type="text"], .filters input[type="date"], .filters select { padding:7px 10px; border-radius:4px; border:1px solid #ccc; font-size:14px; }
#filterKodeBarang { width:300px; }
#filterKodeBuyer { width:200px; }
#filterNamaBarang { width:450px; } /* lebih lebar */
#btnExportExcel { background:#28a745; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; transition:0.3s; }
#btnExportExcel:hover { background:#218838; }
table { width:100%; min-width:700px; border-collapse:collapse; background:#fff; box-shadow:0 0 5px rgba(0,0,0,0.1); table-layout:auto; }
th, td { border:1px solid rgba(0,0,0,0.3); padding:8px; text-align:center; }
th { background:#1e90ff; color:white; user-select:none; cursor:pointer; }
tr:nth-child(even){ background:#f9f9f9; }
tr:hover{ background:#d0e7ff; }
td.nama-barang { text-align:left; padding-left:8px; }
td.angka-kanan { text-align:right; font-family:monospace; padding-right:10px; font-size:16px; }
td.saldo-nol { background:#f8d7da; }
td.saldo-rendah { background:#fff3cd; }
.pagination { margin-top:auto; text-align:center; padding-bottom:10px; }
.pagination button { margin:0.3rem; padding:0.5rem 1rem; cursor:pointer; border:none; background:#1e90ff; color:white; border-radius:4px; transition:0.3s; }
.pagination button:disabled { background:#ccc; cursor:default; }
.marquee-info { background:#f2f2f2; padding:8px 16px; font-weight:bold; color:#333; white-space:nowrap; overflow:hidden; border:1px solid #ccc; border-radius:4px; user-select:none; margin-top:10px; flex-shrink:0; }
footer { background:#007bff; color:white; text-align:center; padding:10px 0; flex-shrink:0; }

/* Modal kartu stok */
#modalKartuStok { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
#modalKartuStok .modal-content { background:#fff; padding:20px; border-radius:8px; width:95%; max-width:1000px; max-height:90vh; overflow:auto; }
#modalKartuStok table { width:100%; border-collapse:collapse; margin-top:10px; table-layout:auto; min-width:700px; font-family:monospace; }
#modalKartuStok th, #modalKartuStok td { border:1px solid #333; padding:6px; text-align:center; }
#modalKartuStok th { background:#1e90ff; color:white; }

/* Toggle button untuk mobile sidebar */
#toggleSidebar { display:none; position:fixed; top:10px; left:10px; z-index:1000; padding:5px 10px; font-size:20px; cursor:pointer; }

/* MOBILE STYLE */
@media(max-width:768px){
  header { font-size:24px; line-height:60px; height:60px; }
  table { font-size:8px; min-width:0; }
  th, td { padding:4px 6px; }
  td.nama-barang { padding-left:4px; }
  td.angka-kanan { padding-right:4px; font-size:8px; }
  .filters input, .filters select, #btnExportExcel { font-size:8px; padding:5px 8px; }
  .sidebar a, .sidebar button { font-size:14px; padding:8px 10px; }
  .pagination button { padding:0.3rem 0.6rem; font-size:12px; }
  .marquee-info { font-size:8px; padding:4px 8px; }

  /* Sidebar collapsible */
  #toggleSidebar { display:block; }
  .sidebar { position:fixed; top:60px; left:0; width:200px; transform:translateX(-100%); z-index:999; height:calc(100% - 60px); }
  .sidebar.open { transform:translateX(0); }
  .content { margin-left:0; }
}
/* Tombol export */
#btnExportExcel {
  flex: 1 1 100px;
  max-width: 120px;
  height: 36px;
  line-height: 36px;
  padding: 0 12px;
  cursor: pointer;
  background:#28a745;
  color:white;
  border:none;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Mobile */
@media(max-width:768px){
  .filters input,
  .filters select,
  #btnExportExcel {
    flex: 1 1 100px;
    max-width: 100%;
    font-size: 10px;
    height: 28px;
    line-height: 28px;
    padding: 0 4px;
  }
}
</style>
</head>
<body>
<div class="wrapper">
  <header>
    Inventory Gudang
    <div id="autoRefreshIndicator"></div>
  </header>
  <button id="toggleSidebar">☰</button>

  <div class="main-content">
    <nav class="sidebar" id="sidebar">
      <a href="form-masuk.html">Barang Masuk</a>
      <a href="form-keluar.html">Barang Keluar</a>
      <a href="mutasi.html">Mutasi Barang</a>
      <a href="laporan-stok-opname.html">Laporan Stok Opname</a>
      <a href="fsnm.html">FSNM Report</a>
      <button id="btnLogout" style="background:#d9534f;">Logout</button>
    </nav>

    <main class="content" id="mainContent">
      <div class="filters">
        <input type="text" id="filterKodeBarang" placeholder="Kode Barang" />
        <select id="filterKodeBuyer"></select>
        <input type="text" id="filterNamaBarang" placeholder="Nama Barang" />
        <button id="btnExportExcel">Export Excel</button>
      </div>

      <div class="table-wrapper">
        <table id="tabelInventory">
          <thead>
            <tr>
              <th>Kode Barang</th>
              <th>Kode Buyer</th>
              <th>Nama Barang</th>
              <th>Satuan</th>
              <th>Stok Tersisa</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination">
        <button id="prevPage">Sebelumnya</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Berikutnya</button>
      </div>

      <marquee class="marquee-info" behavior="scroll" direction="left" scrollamount="4">Info penting berjalan di sini...</marquee>
    </main>
  </div>
  
  <footer>Copyright © 2025 Eland</footer>
</div>

<!-- Modal Kartu Stok -->
<div id="modalKartuStok">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
      <h3 id="judulKartuStok">Kartu Stok</h3>
      <span style="cursor:pointer; font-size:28px; font-weight:bold;" id="closeModal">&times;</span>
    </div>

    <div style="margin:10px 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <label>Dari: <input type="date" id="filterTanggalDariModal"></label>
      <label>Sampai: <input type="date" id="filterTanggalSampaiModal"></label>
      <button id="btnPrintKartu" style="background:#28a745; color:white; padding:5px 10px; border:none; border-radius:4px; cursor:pointer;">Print</button>
    </div>

    <div style="overflow-x:auto; max-height:70vh;">
      <table>
        <thead>
          <tr>
            <th style="width:12%;">Tanggal</th>
            <th style="width:15%;">Kode Buyer</th>
            <th style="width:10%;">Masuk</th>
            <th style="width:10%;">Keluar</th>
            <th style="width:12%;">Saldo</th>
            <th style="width:41%;">Keterangan</th>
          </tr>
        </thead>
        <tbody id="tbodyKartuStok"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Sidebar toggle mobile
const toggleSidebarBtn = document.getElementById("toggleSidebar");
const sidebar = document.getElementById("sidebar");
toggleSidebarBtn.addEventListener("click", ()=> sidebar.classList.toggle("open"));

// Firebase Init
const firebaseConfig = {
  apiKey: "AIzaSyACOluEhfPw4JBlBaHyXtf1k3TIJAHikKo",
  authDomain: "inventory-gudang-16dfe.firebaseapp.com",
  projectId: "inventory-gudang-16dfe",
  storageBucket: "inventory-gudang-16dfe.appspot.com",
  messagingSenderId: "663364522026",
  appId: "1:663364522026:web:f48fb1ba0331695de83353"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Auth
auth.onAuthStateChanged(user => { if(!user) window.location.href='login.html'; });
document.getElementById('btnLogout').addEventListener('click', ()=>{ auth.signOut().then(()=>window.location.href='login.html'); });

// Modal Kartu Stok
const modalKartu = document.getElementById("modalKartuStok");
const tbodyKartuStok = document.getElementById("tbodyKartuStok");
const judulKartuStok = document.getElementById("judulKartuStok");
const closeModal = document.getElementById("closeModal");
closeModal.onclick = ()=> modalKartu.style.display="none";
window.onclick = e=> { if(e.target==modalKartu) modalKartu.style.display="none"; };

let kartuStokData = [];
async function bukaKartuStok(kodeBarang, namaBarang){
  modalKartu.style.display="flex";
  judulKartuStok.textContent = `Kartu Stok - ${kodeBarang} (${namaBarang})`;
  tbodyKartuStok.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  try {
    const masukSnap = await db.collection("barangMasuk").where("kode_barang","==",kodeBarang).get();
    const keluarSnap = await db.collection("barangKeluar").where("kode_barang","==",kodeBarang).get();
    let data = [];
    masukSnap.forEach(doc => {
      const d = doc.data();
      data.push({ tanggal:d.tanggal, kode_buyer:d.kode_buyer||"", masuk:d.jumlah||0, keluar:0, keterangan:d.keterangan||"Barang Masuk" });
    });
    keluarSnap.forEach(doc => {
      const d = doc.data();
      data.push({ tanggal:d.tanggal, kode_buyer:d.kode_buyer||"", masuk:0, keluar:d.jumlah||0, keterangan:d.keterangan||"Barang Keluar" });
    });
    data.sort((a,b)=>new Date(a.tanggal)-new Date(b.tanggal));
    kartuStokData = data;
    renderKartuStok();
  } catch(err) {
    console.error(err);
    tbodyKartuStok.innerHTML="<tr><td colspan='6'>Gagal ambil data.</td></tr>";
  }
}

function renderKartuStok(){
  const dari = document.getElementById("filterTanggalDariModal").value;
  const sampai = document.getElementById("filterTanggalSampaiModal").value;
  let filtered = kartuStokData.filter(row => {
    const tgl = new Date(row.tanggal);
    let valid = true;
    if(dari) valid = valid && tgl >= new Date(dari);
    if(sampai) valid = valid && tgl <= new Date(sampai);
    return valid;
  });

  let saldo = 0;
  tbodyKartuStok.innerHTML = "";
  filtered.forEach(row => {
    saldo += row.masuk - row.keluar;
    let saldoClass = "";
    if(saldo===0) saldoClass="saldo-nol";
    else if(saldo<=5) saldoClass="saldo-rendah";

    tbodyKartuStok.innerHTML += `<tr>
      <td>${row.tanggal}</td>
      <td>${row.kode_buyer}</td>
      <td class="angka-kanan">${row.masuk?row.masuk.toLocaleString("id-ID"):""}</td>
      <td class="angka-kanan">${row.keluar?row.keluar.toLocaleString("id-ID"):""}</td>
      <td class="angka-kanan ${saldoClass}">${saldo.toLocaleString("id-ID")}</td>
      <td>${row.keterangan}</td>
    </tr>`;
  });
  if(filtered.length===0) tbodyKartuStok.innerHTML="<tr><td colspan='6'>Tidak ada data mutasi.</td></tr>";
}

document.getElementById("filterTanggalDariModal").addEventListener("change", renderKartuStok);
document.getElementById("filterTanggalSampaiModal").addEventListener("change", renderKartuStok);

document.getElementById("btnPrintKartu").addEventListener("click", ()=>{ 
  const judul = document.getElementById("judulKartuStok").textContent;
  const tableHTML = document.querySelector("#modalKartuStok table").outerHTML;
  const w = window.open("", "_blank");
  w.document.write(`<html><head><title>${judul}</title><style>
    body{font-family:monospace;padding:20px;}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #333;padding:6px;text-align:center;}
    th{background:#1e90ff;color:white;}
    .saldo-nol{background:#f8d7da;}
    .saldo-rendah{background:#fff3cd;}
  </style></head><body>${tableHTML}</body></html>`);
  w.document.close();
  w.print();
});

// Inventory
let inventoryData = [];
let currentPage = 1;
let rowsPerPageDesktop = 20;
let rowsPerPageMobile = 10;

function getRowsPerPage(){ return window.innerWidth<=768 ? rowsPerPageMobile : rowsPerPageDesktop; }

async function loadInventory(){
  const masukSnap = await db.collection("barangMasuk").get();
  const keluarSnap = await db.collection("barangKeluar").get();
  let tempData = {};

  masukSnap.forEach(doc => {
    const d = doc.data();
    if(!tempData[d.kode_barang]) tempData[d.kode_barang]={kode_barang:d.kode_barang,kode_buyer:d.kode_buyer||"",nama_barang:d.nama_barang||"",satuan:d.satuan||"",masuk:0,keluar:0,stok:0};
    tempData[d.kode_barang].masuk += d.jumlah||0;
  });

  keluarSnap.forEach(doc => {
    const d = doc.data();
    if(!tempData[d.kode_barang]) tempData[d.kode_barang]={kode_barang:d.kode_barang,kode_buyer:d.kode_buyer||"",nama_barang:d.nama_barang||"",satuan:d.satuan||"",masuk:0,keluar:0,stok:0};
    tempData[d.kode_barang].keluar += d.jumlah||0;
  });

  inventoryData = Object.values(tempData).map(d=>{
    d.stok = d.masuk - d.keluar;
    return d;
  }).sort((a,b)=> a.kode_barang.localeCompare(b.kode_barang));

  renderInventory();
  loadBuyerDropdown(); // update dropdown
}

function renderInventory(){
  const filterKode = document.getElementById("filterKodeBarang").value.toLowerCase();
  const filterBuyer = document.getElementById("filterKodeBuyer").value;
  const filterNama = document.getElementById("filterNamaBarang").value.toLowerCase();
  const tbody = document.querySelector("#tabelInventory tbody");
  tbody.innerHTML="";

  let filtered = inventoryData.filter(d=>{
    return d.kode_barang.toLowerCase().includes(filterKode) &&
           (filterBuyer==="" || d.kode_buyer===filterBuyer) &&
           d.nama_barang.toLowerCase().includes(filterNama);
  });

  let totalPages = Math.ceil(filtered.length/getRowsPerPage());
  if(currentPage>totalPages) currentPage=totalPages||1;
  const start = (currentPage-1)*getRowsPerPage();
  const end = start+getRowsPerPage();
  const pageData = filtered.slice(start,end);

  pageData.forEach(d=>{
    let saldoClass="";
    if(d.stok===0) saldoClass="saldo-nol";
    else if(d.stok<=5) saldoClass="saldo-rendah";

    tbody.innerHTML += `<tr>
      <td>${d.kode_barang}</td>
      <td>${d.kode_buyer}</td>
      <td class="nama-barang">${d.nama_barang}</td>
      <td>${d.satuan}</td>
      <td class="angka-kanan ${saldoClass}">${d.stok.toLocaleString("id-ID")}</td>
      <td><button onclick="bukaKartuStok('${d.kode_barang}','${d.nama_barang}')">Kartu Stok</button></td>
    </tr>`;
  });

  document.getElementById("pageInfo").textContent = `Halaman ${currentPage} dari ${totalPages||1}`;
  document.getElementById("prevPage").disabled = currentPage<=1;
  document.getElementById("nextPage").disabled = currentPage>=totalPages;
}

// Pagination
document.getElementById("prevPage").addEventListener("click", ()=>{ currentPage--; renderInventory(); });
document.getElementById("nextPage").addEventListener("click", ()=>{ currentPage++; renderInventory(); });

// Filters
document.getElementById("filterKodeBarang").addEventListener("input", ()=>{ currentPage=1; renderInventory(); });
document.getElementById("filterKodeBuyer").addEventListener("change", ()=>{ currentPage=1; renderInventory(); });
document.getElementById("filterNamaBarang").addEventListener("input", ()=>{ currentPage=1; renderInventory(); });

// Auto-refresh indicator
const indicator = document.getElementById("autoRefreshIndicator");
function blinkIndicator(){
  indicator.style.background="#28a745";
  setTimeout(()=>indicator.style.background="#ccc",500);
}

// Export Excel
document.getElementById("btnExportExcel").addEventListener("click", ()=>{
  const table = document.getElementById("tabelInventory");
  const wb = XLSX.utils.table_to_book(table,{sheet:"Inventory"});
  XLSX.writeFile(wb,"InventoryGudang.xlsx");
});

// Load buyer dropdown hanya dari barangMasuk
async function loadBuyerDropdown(){
  const buyersSet = new Set();
  const masukSnap = await db.collection("barangMasuk").get();
  masukSnap.forEach(doc => {
    const d = doc.data();
    if(d.kode_buyer) buyersSet.add(d.kode_buyer);
  });

  const filterBuyer = document.getElementById("filterKodeBuyer");
  filterBuyer.innerHTML = `<option value="">Semua Buyer</option>`;
  Array.from(buyersSet).sort().forEach(buyer => {
    const opt = document.createElement("option");
    opt.value = buyer;
    opt.textContent = buyer;
    filterBuyer.appendChild(opt);
  });
}


loadInventory();

// Auto refresh setiap 2 detik
setInterval(()=>{ loadInventory(); blinkIndicator(); },2000);
</script>
</body>
</html>
