<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekapitulasi Total Pemakaian Material</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        display: flex;
    }

    /* SIDEBAR */
    .sidebar {
        width: 240px;
        background: #333;
        color: #fff;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        display: flex;
        flex-direction: column;
        padding: 20px 10px;
    }

    .sidebar a {
        display: block;
        color: #ccc;
        text-decoration: none;
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        transition: 0.2s;
        font-size: 15px;
    }

    .sidebar a:hover {
        background: #333;
        color: #fff;
    }

    .content {
        margin-left: 260px;
        width: calc(100% - 260px);
        padding: 25px;
    }

    .card {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    th {
        background: #1e90ff;
        color: #fff;
        padding: 10px;
        text-align: center;
    }

    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .text-left  { text-align: left; }
    .angka-kanan { text-align: right; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar"></div>

<!-- CONTENT -->
<div class="content">
    <h1>Rekapitulasi Total Pemakaian Material</h1>

    <div class="card">
        <label><b>Kode Buyer</b></label>
        <select id="filterKodeBuyer"></select>

        <br><br>

        <label><b>Periode</b></label><br>
        Dari: <input type="date" id="filterTanggalDari">
        Sampai: <input type="date" id="filterTanggalSampai">

        <br><br>

        <button id="btnTampilkanRekap">Tampilkan</button>
        <button id="btnExportExcel">Export Excel</button>
        <button id="btnPrintPreview">Print Preview</button>

    </div>

    <div class="card">
        <table id="rekapTable">
            <thead>
                <tr>
                    <th>KODE BARANG</th>
                    <th>NAMA BARANG</th>
                    <th>SATUAN</th>
                    <th>JUMLAH</th>
                </tr>
            </thead>
            <tbody id="tbodyRekap"></tbody>
        </table>
    </div>
</div>

<script>
/* ---------------- FIREBASE ----------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyACOluEhfPw4JBlBaHyXtf1k3TIJAHikKo",
    authDomain: "inventory-gudang-16dfe.firebaseapp.com",
    projectId: "inventory-gudang-16dfe",
    storageBucket: "inventory-gudang-16dfe.appspot.com",
    messagingSenderId: "663364522026",
    appId: "1:663364522026:web:f48fb1ba0331695de83353"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user => { if(!user) location.href = "login.html"; });

const selectBuyer = document.getElementById("filterKodeBuyer");
const inputDari = document.getElementById("filterTanggalDari");
const inputSampai = document.getElementById("filterTanggalSampai");
const btnTampilkan = document.getElementById("btnTampilkanRekap");
const btnExport = document.getElementById("btnExportExcel");
const btnPreviewPDF = document.getElementById("btnPreviewPDF");
const tbodyRekap = document.getElementById("tbodyRekap");

let rekapitulasiData = [];

/* ---------------- PARSE TANGGAL KUAT ----------------------- */
function parseTanggal(str) {
    if (!str) return null;
    if (str.seconds) return new Date(str.seconds * 1000);
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return new Date(str + "T00:00:00");
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
        const [d,m,y] = str.split("/");
        return new Date(`${y}-${m}-${d}T00:00:00`);
    }
    if (/^\d{2}-\d{2}-\d{4}$/.test(str)) {
        const [d,m,y] = str.split("-");
        return new Date(`${y}-${m}-${d}T00:00:00`);
    }
    return null;
}

/* ---------------- SET TANGGAL ----------------------- */
function setInitialDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    inputDari.value = firstDay.toISOString().split("T")[0];
    inputSampai.value = today.toISOString().split("T")[0];
}

/* ---------------- LOAD BUYER DROPDOWN ----------------------- */
async function loadBuyerDropdown() {
    const snap = await db.collection("barangKeluar").get();
    const buyers = new Set();
    snap.forEach(doc => buyers.add(doc.data().kode_buyer));
    selectBuyer.innerHTML =
        `<option value="">--- Pilih Kode Buyer ---</option>` +
        [...buyers].sort().map(b => `<option>${b}</option>`).join("");
}

/* ---------------- LOAD REKAP ----------------------- */
async function loadRekapitulasi() {
    const kodeBuyer = selectBuyer.value;
    const dari = inputDari.value;
    const sampai = inputSampai.value;

    if (!kodeBuyer) return alert("Pilih kode buyer!");
    if (!dari || !sampai) return alert("Lengkapi periode tanggal!");

    tbodyRekap.innerHTML =
        `<tr><td colspan="4" class="text-center">Mengambil data...</td></tr>`;

    const q = await db.collection("barangKeluar")
        .where("kode_buyer", "==", kodeBuyer)
        .get();

    let agg = {};
    const tFrom = new Date(dari + "T00:00:00");
    const tTo = new Date(sampai + "T23:59:59");

    q.forEach(doc => {
        const d = doc.data();
        const tgl = parseTanggal(d.tanggal);
        if (!tgl) return;

        if (tgl >= tFrom && tgl <= tTo) {
            const key = d.kode_barang;
            if (!agg[key]) {
                agg[key] = {
                    kode_barang: d.kode_barang,
                    nama_barang: d.nama_barang || "",
                    satuan: d.satuan || "",
                    total_jumlah: 0
                };
            }
            agg[key].total_jumlah += d.jumlah || 0;
        }
    });

    rekapitulasiData = Object.values(agg)
        .sort((a,b)=>a.kode_barang.localeCompare(b.kode_barang));

    renderRekap(rekapitulasiData);
}

/* ---------------- RENDER TABEL ----------------------- */
function renderRekap(data) {
    if (data.length === 0) {
        tbodyRekap.innerHTML =
            `<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>`;
        return;
    }

    let html = [];
    let total = 0;

    data.forEach(d => {
        total += d.total_jumlah;
        html.push(`
            <tr>
                <td class="text-center">${d.kode_barang}</td>
                <td class="text-left">${d.nama_barang}</td>
                <td class="text-center">${d.satuan}</td>
                <td class="angka-kanan">
                    ${d.total_jumlah.toLocaleString("id-ID")}
                </td>
            </tr>
        `);
    });

    html.push(`
        <tr style="font-weight:bold; background:#eee;">
            <td colspan="3" class="text-right">TOTAL KUANTITAS:</td>
            <td class="angka-kanan">${total.toLocaleString("id-ID")}</td>
        </tr>
    `);

    html.push(`
        <tr style="font-weight:bold; background:#dfe6e9;">
            <td colspan="3" class="text-right">TOTAL ITEM:</td>
            <td class="angka-kanan">${data.length}</td>
        </tr>
    `);

    tbodyRekap.innerHTML = html.join("");
}

/* ---------------- EXPORT EXCEL ----------------------- */
btnExport.addEventListener("click", () => {
    if (!rekapitulasiData.length) return alert("Tidak ada data!");

    const buyer = selectBuyer.value;
    const dari = inputDari.value;
    const sampai = inputSampai.value;

    const wb = XLSX.utils.book_new();

    let ws_data = [
        ["REKAPITULASI TOTAL PEMAKAIAN MATERIAL"],
        [`KODE BUYER: ${buyer} | PERIODE: ${dari} s/d ${sampai}`],
        [],
        ["KODE BARANG","NAMA BARANG","SATUAN","TOTAL JUMLAH"]
    ];

    rekapitulasiData.forEach(d =>
        ws_data.push([d.kode_barang, d.nama_barang, d.satuan, d.total_jumlah])
    );

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Rekap");
    XLSX.writeFile(
        wb,
        `Rekap_${buyer}_${dari}_sd_${sampai}.xlsx`
    );
});

/* ---------------- PRINT PREVIEW PDF ----------------------- */
document.getElementById("btnPrintPreview").addEventListener("click", () => {
    if (!rekapitulasiData.length) {
        alert("Tidak ada data untuk dicetak!");
        return;
    }

    const buyer = selectBuyer.value;
    const dari = inputDari.value;
    const sampai = inputSampai.value;

    const rows = rekapitulasiData.map(d => `
        <tr>
            <td>${d.kode_barang}</td>
            <td style="text-align:left;">${d.nama_barang}</td>
            <td>${d.satuan}</td>
            <td style="text-align:right;">${d.total_jumlah.toLocaleString('id-ID')}</td>
        </tr>
    `).join("");

    const totalQty = rekapitulasiData.reduce((s,a) => s + a.total_jumlah, 0);

    const printWindow = window.open("", "_blank");

const totalItem = rekapitulasiData.length;

printWindow.document.write(`
    <html>
    <head>
        <title>Print Preview Rekapitulasi</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            h2, h4 { text-align:center; margin:0; padding:0; }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 10px;
            }
            th, td {
                border: 1px solid #333;
                padding: 6px 8px;
            }
            th {
                background: #eee;
            }
            .text-center { text-align:center; }
            .text-left { text-align:left; }
            .text-right { text-align:right; }
            @page {
                size: portrait;
                margin: 30mm;
            }
        </style>
    </head>
    <body>
        <h2>REKAPITULASI TOTAL PEMAKAIAN MATERIAL</h2>
        <h4>BUYER: ${buyer} | PERIODE: ${dari} s/d ${sampai}</h4>

        <table>
            <thead>
                <tr>
                    <th>KODE BARANG</th>
                    <th>NAMA BARANG</th>
                    <th>SATUAN</th>
                    <th>JUMLAH</th>
                </tr>
            </thead>
            <tbody>
                ${rekapitulasiData.map(d => `
                    <tr>
                        <td class="text-center">${d.kode_barang}</td>
                        <td class="text-left">${d.nama_barang}</td>
                        <td class="text-center">${d.satuan}</td>
                        <td class="text-right">${d.total_jumlah.toLocaleString('id-ID')}</td>
                    </tr>
                `).join("")}
                <tr style="font-weight:bold; background:#fafafa;">
                    <td colspan="3" class="text-right">TOTAL JUMLAH :</td>
                    <td class="text-right">${rekapitulasiData.reduce((s,a)=>s+a.total_jumlah,0).toLocaleString('id-ID')}</td>
                </tr>
                <tr style="font-weight:bold; background:#f0f0f0;">
                    <td colspan="3" class="text-right">TOTAL ITEM :</td>
                    <td class="text-right">${rekapitulasiData.length}</td>
                </tr>
            </tbody>
        </table>

        <script>
            window.onload = () => window.print();
        <\/script>
    </body>
    </html>
`);


    printWindow.document.close();
});


/* ---------------- INIT ----------------------- */
document.addEventListener("DOMContentLoaded", () => {
    setInitialDates();
    loadBuyerDropdown();
    btnTampilkan.addEventListener("click", loadRekapitulasi);
});
</script>

</body>
</html>
